{% extends "base.html.twig" %}
{% set lastloop = 0 %}

{% form_theme edit_form 'AppBundle:Form:bootstrap_3_horizontal_layout.html.twig' %}

{% block title %}
    {{ '%entity% edit'|trans({'%entity%': 'menu.material'|trans({}, 'messages')}, 'admin') }} - {{ parent() }}
{% endblock %}

{% block body_title %}
    <i class="fa fa-pie-chart"></i>
    {{ '%entity% edit'|trans({'%entity%': 'menu.material'|trans({}, 'messages')}, 'admin') }}
{% endblock %}

{% block glstock_body %}
    {{ form_start(edit_form) }}
        {{ form_row(edit_form.name) }}

        <div class="form-group">
            <span class="text-danger">{{ form_errors(edit_form.articles) }}</span>
            {{ form_label(edit_form.articles) }}
            {%- block choice_widget_expanded -%}
            <div class="col-sm-8">
                <ul {% if block('widget_container_attributes') is defined %}{{ block('widget_container_attributes') }}{% endif %} class="height150 form-control half panel panel-default panel-body list-unstyled">
                    {%- for child in edit_form.articles -%}
                        {% set lastloop = loop.index %}
                        {% for article in articles %}
                            {% if child.vars.value == article.id %}
                                <li class="row">
                                    <div class="col-sm-6">{{- form_widget(child, { 'attr':{'onClick':'isMultiple('~lastloop~')'} }) -}}</div>
                                    <div class="col-sm-6">
                                        <input type="hidden" id="material_articles_unit_{{ lastloop }}" value="{{ article.unitStorage.id }}">
                                        {{ article.unitStorage.name }}
                                    </div>
                                </li>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {%- endblock choice_widget_expanded -%}
            {{ form_widget(edit_form.articles) }}
        </div>

        {{ form_row(edit_form.multiple) }}
        {{ form_row(edit_form.unitStorage) }}
        {{ form_row(edit_form.active) }}

        <div class="form-group">
            <div class="col-sm-8 col-sm-offset-3">
                <div class="btn-group record_actions">
                    {{ form_widget(edit_form.save) }}
                </div>
            </div>
        </div>
                
    {{ form_end(edit_form) }}

    {{ form_start(delete_form) }}
        {{ form_widget(delete_form) }}

        <div class="btn-group record_actions">
            {% include 'homeButton.html.twig' %}
            <a class="btn btn-info btn-list" href="{{ path('material') }}">
                {{ 'gestock.return_list'|trans }}
            </a>

            <button class="btn btn-danger btn-delete" type="submit">
                {{ 'Delete'|trans({}, 'admin') }}
            </button>

        </div>

        <input name="modal" type="hidden" value="0">
    {{ form_end(delete_form) }}

    {% include 'deleteForm.html.twig' %}

    <script type="text/javascript">
        function isMultiple(id){
            var multiple = 0;
            var articlesCount = {{ edit_form.articles|length }} + 1;

            var unit = $('#material_articles_unit_' + id).val();
            $('#{{ edit_form.unitStorage.vars.id }}').val(unit);

            for (var iter = 1; iter <= articlesCount; iter++) {
                if ($('#{{ edit_form.articles.vars.id }}_' + iter).is(':checked')) {
                    multiple++;
                }
            }

            if (multiple > 1) {
                $('#{{ edit_form.multiple.vars.id }}').prop('checked', true);
            } else {
                $('#{{ edit_form.multiple.vars.id }}').prop('checked', false);
            }
        }
    </script>
{% endblock %}
