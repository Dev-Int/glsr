{# src\Glsr\GestockBundle\Resources\views\Gestock\Article\form.html.twig #}

{# Cette vue n'hérite de personne, elle sera inclue par d'autres vues qui, elles, hériteront sûrement du layout. #}
{# Je dis "sûrement" car, ici pour cette vue, on n'en sait rien et c'est une info qui ne nous concerne pas. #}

<h4>{{ 'glsr.gestock.article.form.title'|trans }}</h4>

<div class="well">
    <form method="post" {{ form_enctype(form) }} class="form-horizontal" role='form'>
        {{ form_errors(form) }}
        <fieldset><legend>Informations</legend>
            <section class="row col-md-12">
                <div class="col-md-5 form-group">
                    {{ form_label(form.name, "Intitulé"|trans) }}
                    <span class="text-danger">{{ form_errors(form.name) }}</span>
                    &nbsp;{{ form_widget(form.name) }}
                </div>
                <div class="col-md-5 form-group">
                    {{ form_label(form.supplier, "Fournisseur"|trans) }}
                    <span class="text-danger">{{ form_errors(form.supplier) }}</span>
                    &nbsp;{{ form_widget(form.supplier, { 'attr' : { 'onChange':'getFamilyLog();' } }) }}
                </div>
                <div class="hidden">
                    {{ form_label(form.active, "Actif"|trans) }}
                    <span class="text-danger">{{ form_errors(form.active) }}</span>
                    &nbsp;{{ form_widget(form.active) }}
                </div>
            </section>
            <section class="row col-md-12">
                <div class="col-md-4 form-group">
                    {{ form_label(form.zone_storages, "Zone de stockage"|trans) }}
                    <span class="text-danger">{{ form_errors(form.zone_storages) }}</span>
                    {% block choice_widget_expanded %}
                        {% spaceless %}
                        <div {{ block('widget_container_attributes') }}>
                            <table class="panel panel-default">
                                <tbody class="panel-body">
                                    {% for child in form.zone_storages %}
                                        <tr>
                                            <td class="col-md-1 text-center">{{ form_widget(child) }}</td>
                                            <td class="col-md-2">{{ form_label(child) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endspaceless %}
                    {% endblock choice_widget_expanded %}
                    {{ form_widget(form.zone_storages) }}
                </div>
                <div class="col-md-4 form-group">
                    {{ form_label(form.family_log, "Famille logistique"|trans) }}
                    <span class="text-danger">{{ form_errors(form.family_log) }}</span>
                    &nbsp;{{ form_widget(form.family_log, { 'attr' : { 'onChange':'fillSubFamilyLog();' } }) }}
                </div>
                <div class="col-md-4 form-group">
                    {{ form_label(form.sub_family_log, "Sous-famille"|trans) }}
                    <span class="text-danger">{{ form_errors(form.sub_family_log) }}</span>
                    &nbsp;{{ form_widget(form.sub_family_log) }}
                </div>
            </section>
        </fieldset>
        <fieldset><legend>Caractéristiques</legend>
             <section class="row col-md-12">
                <div class="hidden">
                    {{ form_label(form.quantity, "Quantité"|trans) }}
                    <span class="text-danger">{{ form_errors(form.quantity) }}</span>
                    &nbsp;{{ form_widget(form.quantity) }}
                </div>
                <div class="col-md-1"></div>
                <div class="col-md-5 form-group">
                    {{ form_label(form.unit_storage, "Unité de stockage"|trans) }}
                    <span class="text-danger">{{ form_errors(form.unit_storage) }}</span>
                    &nbsp;{{ form_widget(form.unit_storage) }}
                </div>
                <div class="col-md-6 form-group">
                    {{ form_label(form.price, "Prix"|trans) }}
                    <span class="text-danger">{{ form_errors(form.price) }}</span>
                    &nbsp;{{ form_widget(form.price) }}
                </div>
            </section>
            <section class="row col-md-12">
                <div class="col-md-1"></div>
                <div class="col-md-5 form-group">
                    {{ form_label(form.unit_bill, "Packaging"|trans) }}
                    <span class="text-danger">{{ form_errors(form.unit_bill) }}</span>
                    &nbsp;{{ form_widget(form.unit_bill) }}
                </div>
                <div class="col-md-6 form-group">
                    {{ form_label(form.minstock, "Stock mini"|trans) }}
                    <span class="text-danger">{{ form_errors(form.minstock) }}</span>
                    &nbsp;{{ form_widget(form.minstock) }}
                </div>
                <div class="hidden">
                    {{ form_label(form.realstock, "Stock théorique"|trans) }}
                    <span class="text-danger">{{ form_errors(form.realstock) }}</span>
                    &nbsp;{{ form_widget(form.realstock) }}
                </div>
            </section>
           {{ form_rest(form) }}
        </fieldset>

        <input type="submit" class="btn btn-default btn-primary" value="{{ 'glsr.gestock.article.edit.submit_button'|trans }}" />
    </form>
</div>
<script type="text/javascript">
function fillSubFamilyLog(){
    var id_select = $('#glsr_gestockbundle_article_family_log').val();
    var id_select2 = $('#glsr_gestockbundle_article_sub_family_log').val();
    $.ajax({
        url: "{{ path('fill_subfamilylog') }}",
        type: 'POST',
        data: {'id': id_select},
        dataType: 'json',
        success: function(json){ // quand la réponse de la requete arrive
            $('#glsr_gestockbundle_article_sub_family_log').empty(); // tu vides le select2
            $.each(json, function(index, value) { // et tu boucle sur la réponse contenu dans la variable passé à la function du success "json"
                if (id_select2 !== null && id_select2 === value.idOption){
                    $('#glsr_gestockbundle_article_sub_family_log').append('<option value="'+ value.idOption +'" selected="selected">'+ value.nameOption +'</option>');
                } else {
                $('#glsr_gestockbundle_article_sub_family_log').append('<option value="'+ value.idOption +'">'+ value.nameOption +'</option>');
                }
            });
        }
    });
}

function getFamilyLog(){
    var id_select = $('#glsr_gestockbundle_article_supplier').val();
    $.ajax({
        url: "{{ path('getfamilylog') }}",
        type: 'POST',
        data: {'id': id_select},
        dataType: 'json',
        success: function(json){
            $('#glsr_gestockbundle_article_family_log option:selected').removeAttr('selected')
            $('#glsr_gestockbundle_article_family_log option[value="' + json.familylog + '"').attr('selected', 'selected');
            $('#glsr_gestockbundle_article_family_log').prop('disabled', true);
            if (json.subfamilylog){
                if ($('#glsr_gestockbundle_article_sub_family_log option[value="' + json.subfamilylog + '"').length){
                    $('#glsr_gestockbundle_article_sub_family_log option:selected').removeAttr('selected')
                    $('#glsr_gestockbundle_article_sub_family_log option[value="' + json.subfamilylog + '"').attr('selected', 'selected');
                    $('#glsr_gestockbundle_article_sub_family_log').prop('disabled', true);
                } else {
                    fillSubFamilyLog();
                    getFamilyLog();
                }
            } else {
                $('#glsr_gestockbundle_article_sub_family_log').prop('disabled', false);
                fillSubFamilyLog();
            }
        }
    });
}

</script>
